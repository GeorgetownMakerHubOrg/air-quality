#!/bin/bash

set -e
set -u

USAGE="\
Usage: 
  ./bin/upload DEVICE COMMAND
Example: 
  ./bin/upload /dev/tty.usb-1410 upload"

# go back a directory if we are in the `bin` directory
if [ "$(basename "$PWD")" = "bin" ]; then
    cd .. || exit
fi

# check that correct number of arguments are provided
if [ ! "$#" -eq 2 ]; then
   echo "ERROR: Incorrect number of arguments provided!"
   echo
   echo "$USAGE"
   exit 1
fi

DEVICE="$1"
COMMAND="$2"

###############################################################################
#                              Helper Functions                               #
###############################################################################

# Display a spinning icon while the process specified by pid argument $1 is
# running, with an optional message $2
display_spinner()
{
  pid="$1"
  message="$2"

  i=0
  spin='-\|/'
  while kill -0 "$pid" 2>/dev/null
  do
    i=$(( (i+1) %4 ))
    printf "\r[%s] %s" "${spin:$i:1}" "$message"
    sleep .1
  done
  printf "\r[*] %s\n" "$message"
}

###############################################################################
#                              MicroPython Flash                              #
###############################################################################

esptool.py --port $DEVICE erase_flash 1>/dev/null &
display_spinner $! "Erasing ESP32 Flash Storage"

esptool.py --chip esp32 \
           --port $DEVICE \
           --baud 460800 \
           write_flash \
           --compress \
           --flash_mode dio \
           --flash_freq 40m 0x1000 bin/build/up-firmware.bin \
           1>/dev/null &
display_spinner $! "Flashing Micropython Binary"


###############################################################################
#                                File Transfer                                #
###############################################################################


# Create directories (excluding hidden files using the `-not` switch)
echo "Creating Directories"
for dir in $(find . -not -path '*/\.*' -type d \( ! -iname ".*" \)); do
    echo "  ${dir}"
    ampy -d 0.5 --port $DEVICE mkdir "$dir"
done

# Copy all Python files
echo "Copying Python Files..."
for file in $(find . -name \*.py); do
    echo "  ${file}"
    ampy -d 0.5 --port $DEVICE put "$file" "$file"
done


###############################################################################
#                                Adafruit IO                                  #
###############################################################################

# NOTE: we must set the PYTHONPATH to allow importing `config` from the parent
# directory.

id=$(ampy --port $DEVICE run bin/hwtest.py |grep chip|awk '{print $3}')
echo "Machine ID is: $id"
PYTHONPATH=. python3 bin/setgrp.py "$id"
