#!/bin/bash

#port=/dev/ttys000
port=/dev/tty.usbserial-1410
#port="/dev/tty.usbserial-1430"
#port=/dev/tty.SLAB_USBtoUART
#port="/dev/tty.wchusbserialfd130"
#port="/dev/tty.usbserial-14130" # for Lolin D32 ESP32

# go back a directory if we are in the `bin` directory
if [ "$(basename "$PWD")" = "bin" ]; then
    cd .. || exit
fi


###############################################################################
#                              MicroPython Flash                              #
###############################################################################


echo "Erasing ESP32 Flash Storage"
esptool.py --port $port erase_flash 1>/dev/null

echo "Flashing Micropython Binary"
esptool.py --chip esp32 \
           --port $port \
           --baud 460800 \
           write_flash \
           --compress \
           --flash_mode dio \
           --flash_freq 40m 0x1000 bin/build/esp32-v1.10-194-g41e7ad6.bin \
           1>/dev/null


###############################################################################
#                                File Transfer                                #
###############################################################################


# Create directories (excluding hidden files using the `-not` switch)
echo "Creating Directories"
for dir in $(find . -not -path '*/\.*' -type d \( ! -iname ".*" \)); do
    echo " > ${dir}"
    ampy -d 0.5 --port $port mkdir "$dir"
done

# Copy all Python files
echo "Copying Python Files..."
for file in $(find . -name \*.py); do
    echo " > ${file}"
    ampy -d 0.5 --port $port put "$file" "$file"
done


###############################################################################
#                                Adafruit IO                                  #
###############################################################################


id=$(ampy --port $port run bin/hwtest.py |grep chip|awk '{print $3}')
echo "Machine ID is: $id"
python3 bin/setgrp.py "$id"
